<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Math Quest Full Prototype</title>
<style>
  body {
    margin: 0; background: #222; color: #eee; font-family: monospace;
    display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
    height: 100vh;
  }
  #gameCanvas {
    background: #88c070; image-rendering: pixelated; margin-top: 20px;
    border: 3px solid #444; image-rendering: crisp-edges;
    image-rendering: pixelated;
  }
  #ui {
    width: 640px; margin: 10px auto; text-align: center; font-size: 18px;
  }
  #questionBox {
    background: #444; padding: 15px; border: 2px solid #666; margin-top: 10px;
  }
  #answerInput {
    font-size: 18px; width: 120px; padding: 6px; margin-top: 5px;
  }
  #submitBtn, #startBtn {
    font-size: 18px; padding: 6px 12px; margin-left: 10px;
    cursor: pointer;
  }
  #feedback {
    margin-top: 12px; min-height: 28px;
  }
  #charSelect {
    margin-top: 10px;
    display: flex; justify-content: center; gap: 20px;
  }
  .charOption {
    cursor: pointer;
    border: 3px solid transparent;
    padding: 4px;
    transition: border-color 0.3s;
  }
  .charOption.selected {
    border-color: #ffd700;
  }
  .charOption img {
    width: 64px; height: 64px; image-rendering: pixelated;
    display: block;
  }
</style>
</head>
<body>

<canvas id="gameCanvas" width="640" height="480"></canvas>

<div id="ui">
  <div>
    Grade Level:
    <select id="gradeSelect">
      <option value="1">1</option><option value="2">2</option><option value="3">3</option>
      <option value="4">4</option><option value="5">5</option><option value="6">6</option>
      <option value="7">7</option><option value="8">8</option><option value="9">9</option>
      <option value="10">10</option><option value="11">11</option><option value="12">12</option>
    </select>
  </div>

  <div id="charSelect" title="Choose your character">
    <!-- Character options inserted by JS -->
  </div>

  <button id="startBtn">Start Quest</button>

  <div id="questionBox" style="display:none;">
    <div id="npcText">Walk next to an NPC and start a quest!</div>
    <input type="text" id="answerInput" autocomplete="off" />
    <button id="submitBtn">Submit</button>
    <div id="feedback"></div>
  </div>
</div>

<audio id="bgMusic" loop>
  <source src="https://protoinfrastack.ivondy.com/media/EHEPsX7rUfWLJiaKnTq4718wa7FxxNd4X3b4.mp3" type="audio/mpeg" />
  Your browser does not support the audio element.
</audio>

<script>
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');

  const tileSize = 32;
  const mapWidth = 20;
  const mapHeight = 15;

  // Larger map: 0=grass,1=path
  // Simple town + path layout for demo
  const map = [
    // 20 x 15 tiles total
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,1,1,1,0,0,0,1,1,1,1,1,1,0,0,0,1,1,1,0,
    0,1,0,1,0,0,0,1,0,0,0,0,1,0,0,0,1,0,1,0,
    0,1,0,1,1,1,1,1,0,0,0,0,1,1,1,1,1,0,1,0,
    0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,
    0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,
    0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,
    0,0,0,1,1,1,1,1,0,0,0,0,0,1,1,1,1,1,1,0,
    0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,
    0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,
    0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  ];

  // Player characters from references
  const characters = [
    {name: "Boy with Hat", img: "https://protoinfrastack.ivondy.com/media/F82mVzbClLf4rwQ5IuZBVXaEDCnx2VrgBJbS.png"},
    {name: "Girl with Glasses", img: "https://protoinfrastack.ivondy.com/media/YiMbe81r2qFTOqc3vqM1EnEnfzXT14Wd686Q.png"},
    {name: "Boy Backpack", img: "https://protoinfrastack.ivondy.com/media/0DKTRDeVCZ7baJm1lrih1v4x5W8K6VqNvsDe.png"},
  ];

  // NPCs from references placed on map
  const npcs = [
    {x: 7, y: 1, img: "https://protoinfrastack.ivondy.com/media/554mOd3C9JCaKMs4P0NnvVjH0qZ1GmM5Ao7o.png"},
    {x: 16, y: 7, img: "https://protoinfrastack.ivondy.com/media/PwbCf0x2BY6kWezruCHFrcabV61YiBawCQo5.png"},
    {x: 11, y: 10, img: "https://protoinfrastack.ivondy.com/media/AH6as9LtFPpXbmTQQOAVLuZkgKdrJOSPs5pc.png"},
  ];

  // Variables for game state
  let playerPos = {x:1, y:1};
  let selectedCharIndex = 0;
  let playerImg = new Image();
  let npcImages = [];
  let inQuest = false;
  let currentQuestionIndex = 0;
  let currentQuestions = [];
  let gradeLevel = 1;

  // UI elements
  const gradeSelect = document.getElementById('gradeSelect');
  const startBtn = document.getElementById('startBtn');
  const questionBox = document.getElementById('questionBox');
  const npcText = document.getElementById('npcText');
  const answerInput = document.getElementById('answerInput');
  const submitBtn = document.getElementById('submitBtn');
  const feedback = document.getElementById('feedback');
  const charSelectDiv = document.getElementById('charSelect');
  const bgMusic = document.getElementById('bgMusic');

  // Load images for NPCs
  npcs.forEach(npc => {
    const img = new Image();
    img.src = npc.img;
    npcImages.push(img);
  });

  // Load player image
  function loadPlayerImage() {
    playerImg.src = characters[selectedCharIndex].img;
  }

  // Setup character selection UI
  function setupCharSelection() {
    characters.forEach((char, index) => {
      const div = document.createElement('div');
      div.classList.add('charOption');
      if(index === selectedCharIndex) div.classList.add('selected');
      const img = document.createElement('img');
      img.src = char.img;
      img.alt = char.name;
      div.title = char.name;
      div.appendChild(img);
      div.onclick = () => {
        selectedCharIndex = index;
        document.querySelectorAll('.charOption').forEach(c => c.classList.remove('selected'));
        div.classList.add('selected');
        loadPlayerImage();
        draw();
      };
      charSelectDiv.appendChild(div);
    });
  }

  // Draw map tiles
  function drawMap() {
    for(let y=0; y<mapHeight; y++) {
      for(let x=0; x<mapWidth; x++) {
        const tile = map[y*mapWidth + x];
        if(tile === 0) {
          ctx.fillStyle = '#88c070'; // grass
        } else {
          ctx.fillStyle = '#d2b48c'; // path
        }
        ctx.fillRect(x*tileSize, y*tileSize, tileSize, tileSize);
      }
    }
  }

  // Draw NPCs
  function drawNPCs() {
    npcs.forEach((npc, i) => {
      const img = npcImages[i];
      if(img.complete) {
        ctx.drawImage(img, npc.x * tileSize, npc.y * tileSize, tileSize, tileSize);
      } else {
        img.onload = () => draw();
      }
    });
  }

  // Draw player
  function drawPlayer() {
    if(playerImg.complete) {
      ctx.drawImage(playerImg, playerPos.x * tileSize, playerPos.y * tileSize, tileSize, tileSize);
    } else {
      playerImg.onload = () => draw();
    }
  }

  // Redraw everything
  function draw() {
    drawMap();
    drawNPCs();
    drawPlayer();
  }

  // Check if tile is walkable (path only)
  function canMove(x,y) {
    if(x < 0 || y < 0 || x >= mapWidth || y >= mapHeight) return false;
    return map[y*mapWidth + x] === 1;
  }

  // Check if player adjacent to any NPC
  function getNearby(playerPos.x - npc.x);
      const dy = Math.abs(playerPos.y - npc.y);
      if((dx === 1 && dy === 0) || (dx === 0 && dy === 1)) return npc;
    }
    return null;
  }

  // Handle player movement
  window.addEventListener('keydown', (e) => {
    if(inQuest) return; // no movement during quest

    let newX = playerPos.x;
    let newY = playerPos.y;

    if(e.key === 'ArrowUp') newY--;
    else if(e.key === 'ArrowDown') newY++;
    else if(e.key === 'ArrowLeft') newX--;
    else if(e.key === 'ArrowRight') newX++;

    if(canMove(newX,newY)) {
      playerPos.x = newX;
      playerPos.y = newY;
      draw();
      const npc = getNearbyNPC();
      if(npc) {
        npcText.textContent = 'Press "Start Quest" to get a math challenge!';
      } else {
        npcText.textContent = 'Walk next to an NPC and start a quest!';
        if(inQuest) {
          endQuest();
        }
      }
    }
  });

  // Generate math questions based on grade and difficulty
  function generateQuestion(grade, difficulty) {
    const topics = getTopicsForGrade(grade);
    const topic = topics[Math.floor(Math.random() * topics.length)];

    function randInt(min,max) {
      return Math.floor(Math.random()*(max-min+1)) + min;
    }

    if(topic === 'addition') {
      const a = randInt(difficulty*1, difficulty*10);
      const b = randInt(difficulty*1, difficulty*10);
      return {question: `What is ${a} + ${b}?`, answer: a+b};
    }
    if(topic === 'subtraction') {
      const a = randInt(difficulty*5, difficulty*15);
      const b = randInt(difficulty*1, a);
      return {question: `
